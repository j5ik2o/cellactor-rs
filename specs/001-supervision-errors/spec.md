# 機能仕様: Supervision エラー通知モデル整理

**ブランチ**: `001-supervision-errors`  
**作成日**: 2025-10-28  
**ステータス**: Draft  
**入力**: ユーザ要望: "Pekko/Akkaではアクターが例外をスローすると親アクターであるスーパーバイザにその例外が通知され、当該アクターを停止するか再起動するかを決めます。この例外はエラー通知です。Rustには例外がないです。エラー通知目的であればResultのErrを使ってください。つまり、アクターのハンドラやビヘイビアはResult<(), ActorError>のような戻り値を返すことになります。一方panicは例外に見てますが、エラー通知ではないです。契約違反を通知するような機構です。アクターハンドラでpanicした場合はスーパービジョンでリカバリしないものとします。もちろん、actor-stdではスタックを巻き戻してリカバリしてもいいですが、no_stdではできませんので、基本panicは面倒みない前提でお願いします"

> 原則3遵守のため、protoactor-go `actor/supervision.go`・`actor/context.go` と Pekko(Akka) Typed の supervision API を調査し、Rust actor-core で Result ベースのエラー通知へ置き換える方針を明示する。

## ユーザーストーリーとテスト（必須）

### ユーザーストーリー1 - Result ベースでエラー通知を受け取りたい（優先度: P1）

セルアクター利用開発者として、Actor ハンドラ/Behavior が `Result<(), ActorError>` を返却し、`Err` の場合にスーパーバイザへ通知される仕組みを利用したい。これにより Rust らしいエラー処理で再起動・停止判断を行える。  
参照: Pekko `SupervisorStrategy`, protoactor-go `actor/process.go`.

**優先度の理由**: スーパービジョンが機能するための基礎であり、panic 依存から脱却する最重要要件。  
**独立テスト**: FnMut ハンドラが `Err(ActorError::Transient)` を返したケースで、親スーパーバイザが再起動を選択する統合テスト。

**受け入れシナリオ**:

1. **前提** 子アクターが `Result<(), ActorError>` を返す Behavior で spawn。**操作** `Tell` によりエラーを発生させ `Err` を返す。**結果** 親がエラー詳細を受信し、戦略に従って Restart が実行される。  
2. **前提** 同じ構成で `Err(ActorError::Fatal)` を返す。**操作** エラー発生メッセージを送信。**結果** 親が Stop 戦略を適用し、子アクターが停止する。

---

### ユーザーストーリー2 - panic を契約違反として扱いたい（優先度: P1）

運用担当者として、アクターハンドラが panic した場合は自動復旧しない方針を明示的に設定し、ログと Dead Letter 通知だけで停止させたい。これにより no_std 環境での安全性と予測可能性を維持できる。  
参照: Rust の panic ハンドリング、Pekko の `SupervisorStrategy` における fatal エラー扱い。

**優先度の理由**: panic をリカバリしようとすると no_std で保障できず、設計方針の明確化が必須。  
**独立テスト**: ハンドラ内で `panic!()` を呼び出し、スーパービジョンが再起動を試みないこと、Actor が停止し監視イベントが記録されることを確認。

**受け入れシナリオ**:

1. **前提** スーパーバイザを Restart 戦略に設定。**操作** 子アクターで panic を発生。**結果** 子アクターが停止し、再起動は試行されず親に致命エラーとして通知される。  
2. **前提** actor-std 拡張が設定済み。**操作** 同様に panic を発生。**結果** actor-std のオプションが有効な場合のみスタック巻き戻しによるリカバリをユーザが選択できるが、デフォルトは停止となる。

---

### ユーザーストーリー3 - エラー種別ごとに対応を変えたい（優先度: P2）

セルアクター設計者として、`ActorError` に再起動可否・再試行ポリシーを付与し、スーパービジョンが `Err` 内容に応じて Restart / Resume / Stop / Escalate を判断できるようにしたい。  
参照: Pekko `SupervisorStrategy.Decider`, protoactor-go `actor/supervision.go`.

**優先度の理由**: 単純な停止/再起動だけでなく、エラー内容によって細かな制御を行うことで可用性を最適化する。  
**独立テスト**: ActorError が `Retryable` の場合に再起動、`NonRetryable` の場合に停止、`Ignore` の場合に Resume を選択するシナリオテスト。

**受け入れシナリオ**:

1. **前提** スーパーバイザ戦略が ActorError の種別に応じた Decider を持つ。**操作** `Err(ActorError::Retryable)` を返す。**結果** Restart が実行されログに再試行回数が記録される。  
2. **前提** 同じ戦略。**操作** `Err(ActorError::Ignore)` を返す。**結果** Resume が選択され、アクターは停止せず処理を継続する。

### 境界条件・例外

- ハンドラが `Ok(())` を返した場合は従来どおり処理継続。`Err` のみがスーパーバイザ通知のトリガとなる。  
- panic は契約違反として扱い、再起動・再試行の対象外。ログと監視イベントに記録して停止する。  
- actor-std 拡張でのみ、`panic` を catch_unwind しユーザがリカバリ処理を挿入できるが、デフォルト設定では無効。  
- `ActorError` の種別が Decider にマッチしない場合、デフォルトで `Stop` を選択し安全側へ倒す。  

## 要件（必須）

### 機能要件

- **FR-001**: システムは Actor ハンドラ/Behavior が `Result<(), ActorError>` を返却できる API を提供し、`Err` が発生した際にスーパーバイザへエラー詳細を通知しなければならない。  
- **FR-002**: スーパービジョン戦略は `ActorError` の種別に応じて Restart / Resume / Stop / Escalate を選択できる Decider を実装しなければならない。  
- **FR-003**: `ActorError` は再試行回数・時間窓などのメタ情報を保持し、戦略判断に利用できなければならない。  
- **FR-004**: ハンドラが panic した場合、actor-core では自動復旧を試みず、アクターを停止させて親へ致命エラーイベントを通知しなければならない。  
- **FR-005**: actor-std 拡張ではオプションで panic を catch しリカバリハンドラを挿入できるが、`no_std` 互換のためデフォルトは無効とする。  
- **FR-006**: エラー通知と panic 通知はメトリクス/ログイベントとして記録され、監視システムが再試行／停止回数を分析できなければならない。  
- **FR-007**: ハンドラが `Err` を返した際に保留中メッセージが消失しないよう、メールボックスの状態遷移と連携しなければならない。  
- **FR-008**: すべての機能は `#![no_std]` 環境で動作し、Result ベースエラー処理により追加のランタイム依存を持たないこと。  
- **FR-009**: `Shared` 名命規約と使用最小化方針を満たし、エラー処理で不要な共有参照を生成しないこと。  

### 重要エンティティ

- **ActorError**: 再起動可否、重篤度、メタ情報（再試行回数等）を保持するエラー型。  
- **SupervisionDecider**: ActorError とコンテキストを入力に Restart/Resume/Stop/Escalate を返す判定器。  
- **ErrorSignal**: スーパーバイザへ通知されるイベント。`Err` と panic の両方について種別と詳細を保持。  
- **PanicPolicy**: actor-std 拡張のみが利用する panic リカバリ設定。  

## 成功指標（必須）

### 定量的成果

- **SC-001**: Result ベースのエラー処理により、Retryable エラーの再起動成功率が 95% 以上であること。  
- **SC-002**: Panic 発生時に再起動が試行されるケースが 0 件であること（停止のみ）。  
- **SC-003**: エラー通知イベントが監視メトリクスに 100% 記録され、再試行回数と停止回数の乖離が 0 件であること。  
- **SC-004**: actor-core の `no_std` ビルドでエラー処理パスの追加によるバイナリサイズ増加が 5% 未満に収まること（参照ベンチ）。  

## 前提・制約

- Actor ハンドラ API は前仕様（Typed/Behavior）と整合する形で Result を返すように統一する。  
- panic は契約違反であり、ユーザは panic を利用せず Result でエラーを返すことを推奨する。  
- actor-std の panic リカバリは最終手段であり、`cfg(feature = "std")` 下の拡張タスクで実装する。  
- メトリクスは内部エミッタに送信し、外部公開は将来の observability 仕様で扱う。  

## 非目標

- Rust の unwind メカニズムを actor-core に持ち込むこと（`no_std` 非対応）。  
- 自動リトライのためのバックオフアルゴリズム（別仕様で扱う）。  
- クラスタリング環境でのエラー伝播（本仕様は単一 ActorSystem 内に限定）。  
