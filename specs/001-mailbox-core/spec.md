# 機能仕様: Mailbox 基盤強化と観測性

**ブランチ**: `001-mailbox-core`  
**作成日**: 2025-10-28  
**ステータス**: Draft  
**入力**: ユーザ要望: "メールボックスのキューはutils-coreにあるキュー実装を使ってください。 メールボックスの基本機能は満たしてくださいね。 基本メッセージ投入/受信 System / User メッセージ優先度 Suspend / Resume 制御 オーバーフロー処理（DropNewest / DropOldest / Grow / Block） メトリクス連携（オブザーバービリティ) Throughput / Backpressure ヒント Middleware チェイン サスペンション統計・観測 Stashing / 再投入制御 protoactor-go, pekkoをベースに仕様を再確認してください。"

> 原則3遵守のため、protoactor-go の `mailbox/` パッケージと Apache Pekko の `akka.actor.typed.mailbox`、`dispatcher` 周辺を調査し、差分を仕様各節で説明する。

## ユーザーストーリーとテスト（必須）

### ユーザーストーリー1 - utils-core キューを活用したメールボックス（優先度: P1）

セルアクター利用開発者として、actor-core のメールボックスが utils-core に用意されたキュー実装（ring / priority / mpsc など）を統一的に利用し、`Props::with_mailbox` でキュー種別や容量を選択できるようにしたい。これにより `#![no_std]` 環境でも確実に動作し、コード全体で一貫したデータ構造を再利用できる。  
参照: protoactor-go `mailbox/bounded_mailbox.go`, utils-core queue モジュール設計

**優先度の理由**: actor-core と utils-core の整合を図ることで、組込みターゲットでも安定したメッセージ配送を保証するため。  
**独立テスト**: utils-core の bounded queue を指定したメールボックスで 1000 件のメッセージを投入・消費し、整合性と順序が保たれる統合テスト。

**受け入れシナリオ**:

1. **前提** utils-core bounded queue を選択した Props。**操作** RootContext が PID を spawn し 1000 件のユーザーメッセージを連続送信。**結果** メッセージが投入順に処理され、キューからの欠落や重複が発生しない。  
2. **前提** utils-core priority queue を選択。**操作** System メッセージと User メッセージを交互に投入。**結果** System メッセージが常に先に処理される。

---

### ユーザーストーリー2 - オーバーフローとサスペンド制御（優先度: P1）

運用担当者として、メールボックスが suspend/resume、stashing、オーバーフロー方針（DropNewest / DropOldest / Grow / Block）をサポートし、負荷ピークでも期待通りの挙動を取れるようにしたい。  
参照: protoactor-go `mailbox/mailbox.go`, Pekko `Mailbox`, `StashBuffer`

**優先度の理由**: 制御が不足するとメッセージ喪失や暴走につながり、アクターモデルの信頼性が低下するため。  
**独立テスト**: 各オーバーフローポリシーを設定したメールボックスで閾値超過を発生させ、期待する挙動（破棄 / 最古削除 / 自動拡張 / ブロック）が発生することを確認する結合テスト。

**受け入れシナリオ**:

1. **前提** DropNewest ポリシーで容量 10 のメールボックス。**操作** 11 件目のメッセージを投入。**結果** 最新メッセージが破棄され、監視メトリクスにドロップ件数が記録される。  
2. **前提** Suspend 中のメールボックス。**操作** `Suspend` シグナルを送った後、ユーザーメッセージを送信。**結果** メッセージが Stash に保持され、`Resume` 後に FIFO 順序で再投入される。

---

### ユーザーストーリー3 - 観測性とバックプレッシャー指標（優先度: P2）

セルアクター SRE として、メールボックスの throughput と backpressure、サスペンション統計をメトリクスとして収集し、ミドルウェアチェインからヒントを取得できるようにしたい。これによりモニタリング基盤でボトルネックを可視化し、protoactor-go / Pekko 並みの運用体験を得られる。  
参照: Pekko `Mailbox` メトリクス、protoactor-go `monitoring`

**優先度の理由**: 直接的な機能より一段劣るが、運用可視化は SLA 担保に不可欠。  
**独立テスト**: メトリクスレシーバをモック化し、メールボックス処理量・滞留時間・サスペンド時間が記録されることを確認する統合テスト。

**受け入れシナリオ**:

1. **前提** メトリクスミドルウェアが登録された RootContext。**操作** 1000 件のメッセージを処理。**結果** Throughput（メッセージ/秒）と滞留メトリクスが記録され、閾値超過時に backpressure アラートが生成される。  
2. **前提** サスペンド・再開を繰り返すアクター。**操作** 3 回連続で `Suspend`/`Resume` を実行。**結果** サスペンション時間累計と回数がメトリクスに反映される。

### 境界条件・例外

- System メッセージは優先度で常に User メッセージより先に処理される。優先度設定が欠落した場合はデフォルトで System 優先を採用する。  
- Grow ポリシーは utils-core の動的拡張キュー上限に従い、メモリ確保に失敗した場合は Block ポリシーと同じ挙動で呼び出し元にエラーを伝える。  
- Block ポリシーを選択した場合、no_std 環境ではスピン待機＋バックプレッシャーヒントの送出で代替する。  
- ミドルウェアチェインでエラーが発生した場合、メールボックスはメッセージ再投入を試みるが連続失敗は監視イベントとして通知する。  

## 要件（必須）

### 機能要件

- **FR-001**: システムは actor-core のメールボックス実装において utils-core の queue モジュール（ring、priority、bounded/unbounded）を必ず利用し、Props で選択可能なオプションを提供しなければならない。  
- **FR-002**: メールボックスは System メッセージを User メッセージより高い優先度で処理し、プロセス停止や監視イベントが遅延しないよう保証しなければならない。  
- **FR-003**: メールボックスは `Suspend`/`Resume` 制御と Stash バッファを備え、サスペンド中のメッセージが再開時に FIFO 順序で再投入されなければならない。  
- **FR-004**: メールボックスは DropNewest / DropOldest / Grow / Block の 4 種のオーバーフローポリシーをサポートし、選択したポリシーに応じた監視イベント・メトリクスを記録しなければならない。  
- **FR-005**: メールボックスは処理 Throughput と滞留時間、Stash サイズ、サスペンド時間をメトリクスとしてエクスポートし、Backpressure を検出した際にはミドルウェアチェインへヒント（例: レイテンシ閾値超過）を渡さなければならない。  
- **FR-006**: メールボックスは Inbound/Outbound ミドルウェアチェインを介してメッセージ到達前後にフックを呼び出し、チェイン内で生成されたヒントを backpressure 制御やログに活用できなければならない。  
- **FR-007**: メールボックスは utils-core の `Shared`/`AsyncMutexLike` 抽象を利用し、`alloc::sync::Arc` や標準 Mutex に直接依存してはならない。  
- **FR-008**: メールボックス監視イベント（ドロップ、ブロック、サスペンド）は Protoactor-go / Pekko のイベント種別と対応し、イベントを RootContext に伝播できなければならない。  
- **FR-009**: すべての機能は `#![no_std]` 環境で動作し、`std` が必要なメトリクス送信やログ拡張は `cfg(test)` または `actor-std` 側に委譲しなければならない。  

### 重要エンティティ

- **Mailbox**: メッセージキューとオーバーフローポリシー、サスペンド状態、Stash を保持するコンテナ。  
- **MailboxConfig**: キュー種別、容量、優先度設定、オーバーフローポリシー、メトリクス閾値などのプロパティをまとめた値オブジェクト。  
- **MiddlewareHint**: ミドルウェアチェインが backpressure 状態を通知するためのヒント構造体。  
- **MailboxMetrics**: Throughput、滞留時間、ドロップ数、サスペンド時間などを収集する観測エンティティ。  
- **StashBuffer**: サスペンド中のメッセージを保持し、再開時に再投入を行うバッファ。  

## 成功指標（必須）

### 定量的成果

- **SC-001**: utils-core bounded queue を用いたメールボックスが 1 秒あたり 10,000 メッセージの処理でドロップ率 0%、平均待ち時間 2ms 以下を維持する。  
- **SC-002**: DropNewest / DropOldest / Grow / Block の各ポリシーに対する統合テストで、期待する挙動とイベント記録が 100% 一致する。  
- **SC-003**: サスペンド／再開を 100 回繰り返すテストで Stash FIFO 順序の破壊が 0 件であり、サスペンション時間の観測誤差が ±5% 以内に収まる。  
- **SC-004**: Backpressure 発生時にミドルウェアへ通知されたヒントにより、呼び出し側が 90% 以上のケースで適切な再試行／遅延を実施できたと内製ベンチで評価される。  

## 前提・制約

- utils-core の queue 実装は別機能で整備済みであり、actor-core 側では新規にデータ構造を持たない。  
- メトリクスの外部公開は将来の `actor-std` / observability 拡張で実装し、本仕様では内部エミッタへの送出に留める。  
- no_std 環境では時間計測を utils-core のタイマー抽象に委譲し、Busy loop を避けるためのバックオフ戦略は `SpinAsyncMutex` のポリシーに従う。  
- ミドルウェアチェインの実装は既存の actor-core パイプラインを流用し、新たな DSL を導入しない。  

## 非目標

- リモート／クラスタリング環境でのメールボックス同期や共有。  
- メッセージ優先度をシステム・ユーザー以外の多段階に拡張すること。  
- メトリクスの外部エクスポート（Prometheus エンドポイント等）やダッシュボード実装。  
