# 機能仕様: Typed/Untyped ハンドラー統合

**ブランチ**: `001-typed-handlers`  
**作成日**: 2025-10-28  
**ステータス**: Draft  
**入力**: ユーザ要望: "アクターのハンドラは関数（クロージャー）を渡せるようにしてね。FnMutがよいと想います。関数の引数にはコンテキストとメッセージが必要です。 このライブラリの内部ではメッセージはAnyで扱うようにしてください。ユーザに近い表層の部分でジェネリックにしてください。akka/pekkoのuntyped, typedと同じです。メッセージプロトコルが違うアクター同士の通信はメッセージアダプタが必要になります。これもakka/pekkoが参考になります。"

> 原則3遵守のため、protoactor-go `actor/actor.go`・`actor/props.go` および Pekko(Akka) Typed の `Behavior` / `MessageAdapter` API を参照し、Rust actor-core への変換方針を節ごとに明記する。

## ユーザーストーリーとテスト（必須）

### ユーザーストーリー1 - クロージャでアクターハンドラを定義したい（優先度: P1）

セルアクター利用開発者として、`FnMut(&mut Context<T>, T)` 形式のクロージャを `Props::new` に渡してアクターを生成したい。これによりシンプルな inline 定義やテストでのモック化が容易になる。  
参照: protoactor-go `actor/props.go`、Pekko Typed の `Behaviors.receiveMessage`.

**優先度の理由**: 現在のハンドラ構造体ベースよりも、ユーザが迅速にアクターを定義できる最小単位であり、API 易用性に直結する。  
**独立テスト**: `Props::new(|ctx, msg| {...})` でインクリメントアクターを生成し、複数回 `Tell` して FnMut の可変キャプチャが機能するか検証する統合テスト。

**受け入れシナリオ**:

1. **前提** FnMut クロージャが内部カウンタをキャプチャ。**操作** `Props::new(counter_fn)` で spawn し、3 回 `Tell(1)` を送信。**結果** 3 回目まで累計値が増加し、内部状態が維持される。  
2. **前提** クロージャが RootContext から子アクターを spawn。**操作** `RequestFuture` で応答を要求。**結果** クロージャ内でコンテキスト API が利用でき、Future が期待値を返す。

---

### ユーザーストーリー2 - Typed/Untyped メッセージを橋渡ししたい（優先度: P1）

アプリケーション開発者として、外部 API ではジェネリック型でメッセージを扱いながら、ライブラリ内部では `Any` と PID を用いた型抹消を行い、Pekko の untyped/typed のように両立させたい。これによりユーザは型安全な API を利用しつつ、内部は柔軟なメッセージルーティングを維持できる。  
参照: Pekko Typed `ActorRef<T>`, `akka.actor.ActorRef` ブリッジ.

**優先度の理由**: 型安全と互換性を同時に満たす仕組みがないと、プロトコルの異なるアクター間通信を設計できないため。  
**独立テスト**: 型付き ActorRef を取得したアクターへ `u32` メッセージを送信し、内部 `Any` へ格納 → 受信時に期待型へ戻すフローを検証。型不一致時はアダプタ経由でエラー処理されること。

**受け入れシナリオ**:

1. **前提** `ActorRef<String>` が存在。**操作** `Tell("hello")` を実行。**結果** メッセージが内部 `Any` に格納され、ハンドラで `String` として取り出せる。  
2. **前提** `ActorRef<u32>` に `ActorRef<String>` から直接メッセージを送信。**操作** 変換アダプタ未指定で `Tell("bad")`。**結果** 型不一致としてアダプタ不足エラーが発生し、ログ/メトリクスに記録される。

---

### ユーザーストーリー3 - メッセージアダプタでプロトコル変換したい（優先度: P2）

システム統合エンジニアとして、異なるメッセージ型同士のアクターが通信する際に、Pekko の `MessageAdapter` と同等のアダプタを定義し、受信メッセージを変換してからクロージャに渡したい。  
参照: Pekko Typed `ctx.messageAdapter`, protoactor-go `actor/context.go` の `MessageInvoker`.

**優先度の理由**: 異なるバウンデッドコンテキスト間でプロトコルを橋渡しするために必須であり、Typed/Untyped ハンドラ構造とセットで提供する必要がある。  
**独立テスト**: アダプタ登録済みアクターへ外部プロトコルのメッセージを送信し、アダプタで内部プロトコルへ変換されてから FnMut ハンドラが実行されることを確認。

**受け入れシナリオ**:

1. **前提** コンテキストに `ctx.message_adapter(Adapter::new)` を登録。**操作** 外部 `Event` メッセージを送信。**結果** Adapter が `Command` に変換し、ハンドラが期待どおり処理する。  
2. **前提** 複数のアダプタが同じアクターに登録。**操作** 異なる型のメッセージを連続送信。**結果** 登録順に変換が選択され、適切なハンドラへルーティングされる。

### 境界条件・例外

- FnMut ハンドラが `!Send`/`!Sync` なキャプチャを含む場合はコンパイル時に拒否される。  
- `Any` への格納は actor-core 内部に限定し、ユーザ向け API ではジェネリック型が露出し続ける。  
- MessageAdapter が未登録で型不一致が発生した場合、デフォルトで Dead Letter として RootContext に転送する。  
- 型抹消のために実行時ダウンキャストを用いる箇所は、失敗時にメトリクスとロギングで通知する。  

## 要件（必須）

### 機能要件

- **FR-001**: システムは `FnMut(&mut ActorContext<T>, T)` 形式のクロージャを `Props::new` へ直接渡してアクターを生成できる API を提供しなければならない。  
- **FR-002**: クロージャハンドラは `Context` 参照を通じて spawn / watch / respond など既存のコンテキスト操作を利用できなければならない。  
- **FR-003**: ライブラリ内部のメッセージは `Any` として取り扱い、ProcessRegistry やメールボックスとの連携が型非依存で行えるようにしなければならない。  
- **FR-004**: ユーザ向け `ActorRef<T>` や `Context<T>` はジェネリック型で公開し、送受信メソッドで型安全性を保持しなければならない。  
- **FR-005**: 型の異なるアクター間通信を行う場合、`MessageAdapter` もしくは同等の API を提供し、受信した `U` 型をハンドラが期待する `T` 型へ変換できなければならない。  
- **FR-006**: `MessageAdapter` は複数登録を許容し、送信元タイプに応じて最適なアダプタ（型一致）が選択され、未一致の場合は Dead Letter へ転送されなければならない。  
- **FR-007**: 型変換に失敗した場合、エラーイベントとメトリクスを記録し、RootContext 経由で監視者に通知しなければならない。  
- **FR-008**: クロージャ実装・アダプタ実装ともに `modules/utils-core` の `Shared` 命名規則を遵守し、不要な共有参照を生成してはならない。  
- **FR-009**: すべての API は `#![no_std]` 環境で利用可能であり、`Any` の利用による追加アロケーションを最小限に抑える設計指針（再利用バッファ等）を定めなければならない。  

### 重要エンティティ

- **ActorContext<T>**: ジェネリックなメッセージ API を提供しつつ、内部では型抹消した `Any` を扱うラッパ。  
- **TypedActorRef<T>**: ユーザに公開される型付きハンドル。内部で untyped PID とアダプタを保持。  
- **UntypedEnvelope**: メールボックス内部で利用する `Any` メッセージと送信者 PID のコンテナ。  
- **MessageAdapter**: 外部タイプ `U` を内部タイプ `T` へ変換するクロージャ。エラー時のハンドリング方針も保持。  
- **AdapterRegistry**: コンテキストごとに登録されたアダプタを型情報ベースで検索するテーブル。  

## 成功指標（必須）

### 定量的成果

- **SC-001**: FnMut ハンドラのサンプル実装で 95% のメッセージが 5ms 以内に処理され、従来構造体実装と同等のスループットを維持する。  
- **SC-002**: 型不一致のテストケース 100 件で Dead Letter もしくはアダプタ変換が 100% 正しく動作し、未処理メッセージが発生しない。  
- **SC-003**: メッセージアダプタを 3 種登録したアクターで 10,000 件の異種メッセージを処理し、変換失敗率が 0% である。  
- **SC-004**: FnMut-based API を利用したサンプル移植（Pekko ガイド 2 本）が 1 人日以内、コード差分 20% 未満で完了したと開発検証で報告される。  

## 前提・制約

- `Any` 取扱いは `modules/utils-core` が提供する型抹消補助ユーティリティを利用し、独自実装を増やさない。  
- メッセージアダプタは同期実行を前提とし、非同期変換が必要な場合は別途 Future を返すハンドラで対応する。  
- 共有参照が必要な場合でも `_shared` サフィックス命名および最小限の利用に留める。  
- リモート/クラスタ通信向けの型登録やシリアライズ変換は本スコープ外。  

## 非目標

- Actor モデル外コンポーネント（HTTP ハンドラ等）への直接的なアダプタ実装。  
- メッセージスキーマの自動生成やリフレクションベースの型検査。  
- Pekko Typed の `Behavior` DSL 全体の再実装（本仕様ではハンドラ API とアダプタに限定）。  
