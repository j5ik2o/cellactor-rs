# 実装計画

- [x] 1. プロバイダ登録・永続化の基盤整備
  - _対応要件: 1.1, 1.2, 1.3, 1.4, 1.5_
  - _依存タスク: -_
  - _完了条件: 1.x 子タスク完了、Registry が永続化付きで起動・再起動後も同一セットを復元できること_

- [x] 1.1 ProviderRegistry と FileProviderStore の実装
  - Descriptor を登録・重複検知し、JSONL を tempfile+rename+fsync で原子的に保存/読込する。
  - ProviderStore 抽象を定義し、破損ファイル読込時は fail-fast でエラーを返す。
  - _対応要件: 1.1, 1.2, 1.5_
  - _依存タスク: -_
  - _完了条件: 登録/保存/読込/重複検知/破損検知の単体テストが緑_

- [x] 1.2 ProviderValidator の設定検証と外部接続チェッカー
  - 必須フィールド検証と名前衝突エラーを整備し、Consul/K8s 用の接続性チェックフックを用意する。
  - Unsupported capability（watch 無し等）を Disabled として理由を保持する。
  - _対応要件: 1.1, 1.3, 1.4_
  - _依存タスク: 1.1_
  - _完了条件: 正常/欠落/衝突/接続失敗/能力不足の検証テストが緑_

- [x] 2. トポロジウォッチとフェイルオーバ制御
  - _対応要件: 2.1, 2.2, 2.3, 2.4, 2.5, 5.1_
  - _依存タスク: 1.2_
  - _完了条件: 2.x 子タスク完了、優先度付きフェイルオーバが動作しスナップショット供給が継続すること_

- [x] 2.1 ProviderStream/ProviderEvent 実装と WatchHub 配信
  - ProviderEvent(Snapshot/Terminated) を処理し、最新スナップショットと終了シグナルを保持して Placement/Partition/Remoting ブリッジへ配信する。
  - ハッシュ不変時はキャッシュ再利用、ハッシュ変化時は無効化フラグを立てる。
  - _対応要件: 2.1, 2.2, 2.3_
  - _依存タスク: 1.2_
  - _完了条件: スナップショット配信/終了保持/ハッシュ差分処理の単体テストが緑_

- [x] 2.2 FailoverController のヘルス判定とバックオフ
  - タイムアウト・連続エラー・スナップショット遅延を入力にヘルスを評価し、優先度付きにフェイルオーバする。
  - デフォルト値 (timeout15s, max_errors3, backoff 2s→30s, cooldown10s) を設定し、クールダウン中のフラッピング防止を実装。
  - _対応要件: 2.4, 2.5, 5.1_
  - _依存タスク: 2.1_
  - _完了条件: ヘルス遷移/バックオフ/フェイルオーバ/復帰のテストが緑_

- [x] 2.3 ProviderStream と Failover/WatchHub の統合
  - Provider run ループを実装し、スナップショットストリームとフェイルオーバ切替を順序保証付きで配信する。
  - Terminated 発生時の終了シグナル保持と最後のスナップショット供給を統合する。
  - _対応要件: 2.1, 2.2, 2.3, 2.4_
  - _依存タスク: 2.1, 2.2_
  - _完了条件: 統合テストでフェイルオーバ時もスナップショットが連続供給されること_

- [x] 3. Placement / Partition ブリッジ連携
  - _対応要件: 3.1, 3.2, 3.3, 3.4, 3.5_
  - _依存タスク: 2.2_
  - _完了条件: 3.x 子タスク完了、スナップショット適用・provider_changed 通知・Shutdown 拒否が動作すること_

- [x] 3.1 PlacementSupervisorBridge 実装
  - apply_snapshot と provider_changed を実装し、所有権再計算前提で順序保証（seq_no）を処理する。
  - _対応要件: 3.1, 3.4_
  - _依存タスク: 2.2_
  - _完了条件: スナップショット適用と provider_changed イベントの単体テストが緑_

- [x] 3.2 PartitionManagerBridge 実装
  - 最新スナップショット提供と provider_changed 通知を行い、不可時は理由付きで失敗させる。
  - _対応要件: 3.2, 3.4_
  - _依存タスク: 3.1_
  - _完了条件: 正常/スナップショット不足/切替通知のテストが緑_

- [x] 3.3 Graceful Shutdown 制御
  - シャットダウン期間中は新規スナップショットを拒否し、最後のスナップショット保持でドレインを可能にする。
  - _対応要件: 3.5_
  - _依存タスク: 3.2_
  - _完了条件: Shutdown 中の拒否と保持を確認するテストが緑_

- [x] 4. Remoting 連携とノード観測
  - _対応要件: 4.1, 4.2, 4.3, 4.4, 4.5_
  - _依存タスク: 3.3_
  - _完了条件: 4.x 子タスク完了、RemoteTopology イベントが冪等・順序保証で配信されること_

- [x] 4.1 RemotingBridge と RemoteTopologyEvent 契約
  - Join/Leave/Blocked/Unblocked を seq_no + snapshot_hash 付きで発行し、冪等キーを定義する。
  - Remoting 側が隔離ノードを再活性化できるようイベントハンドリング方針を明記する。
  - _対応要件: 4.1, 4.2, 4.4_
  - _依存タスク: 3.3_
  - _完了条件: イベントスキーマと冪等処理のテストが緑_

- [x] 4.2 Block/Unblock 反映と監視警告
  - 隔離ノードをスナップショットの blocked_nodes に反映し、Degraded 状態時は警告を発行する。
  - _対応要件: 4.2, 4.3_
  - _依存タスク: 4.1_
  - _完了条件: Block/Unblock の反映と警告出力のテストが緑_

- [x] 4.3 Remoting 健全性メトリクスと隔離解除フロー
  - up/down/degraded と最終更新時刻を公開し、隔離解除後の再活性化をイベント経路で確認する。
  - _対応要件: 4.3, 4.4, 4.5_
  - _依存タスク: 4.1, 4.2_
  - _完了条件: メトリクスおよび解除イベントのテストが緑_

- [x] 5. 観測・エラーハンドリング・フェイルセーフ
  - _対応要件: 5.1, 5.2, 5.3, 5.4, 5.5_
  - _依存タスク: 4.2_
  - _完了条件: 5.x 子タスク完了、メトリクスとエラーコードがフロー全体で利用可能になること_

- [x] 5.1 ProvisioningMetrics 拡張
  - snapshot latency, failover count, stream interruption を計測し、seq_no と紐付けて観測できるようにする。
  - _対応要件: 5.1_
  - _依存タスク: 4.2_
  - _完了条件: メトリクス更新の単体テストが緑_

- [x] 5.2 ProvisioningError/イベントの構造化エラーコード
  - validation/connectivity/stream failure を区別するエラーコードを定義し、イベントにも reason を含める。
  - _対応要件: 5.2, 5.5_
  - _依存タスク: 5.1_
  - _完了条件: エラーコードの単体テストとイベントへの反映を確認_

- [x] 5.3 全体統合・フェイルケーステスト
  - in-memory + mock Consul/K8s で登録→watch→フェイルオーバ→Placement/Remoting 通知→shutdown の統合テストを追加し、index 巻き戻り・接続失敗・全プロバイダ枯渇の fail-fast を確認する。
  - _対応要件: 1系, 2系, 3系, 4系, 5系_
  - _依存タスク: 5.2_
  - _完了条件: 統合テストが緑で、主要フェイルケースを再現・検証できること_
