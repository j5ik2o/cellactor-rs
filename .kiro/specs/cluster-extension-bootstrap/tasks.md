# 実装計画

- [ ] 1. ブートストラップ基盤とステータス永続化
  - _対応要件: 1.1, 1.2, 1.3, 1.4, 1.5_
  - _依存タスク: -_
  - _完了条件: 1.x 子タスク完了かつ install 経路で Ready/Disabled/Error の判定と保存が動作すること_

- [x] 1.1 BootstrapStatusStore 実装とステータスロード/保存
  - Ready/Disabled/Error{reason} を永続化するストアを用意し、デフォルトはインメモリ、外部ストア差し替えポイントを設ける。
  - install 前に状態を読み込み、install 後に結果を保存するフローを組み込み、保存失敗は起動を即時失敗させる。
  - ClusterExtensionHandle から現在状態を問い合わせできるようハンドルを露出し、再起動時の可否判定を可能にする。
  - _対応要件: 1.5_
  - _依存タスク: -_
  - _完了条件: 状態遷移とエラーパスの単体テストが緑で、永続化差し替えも確認できること_

- [x] 1.2 ブートストラップ install フローの拡張
  - ActorSystem 起動前に Runtime/Context/Metrics/PartitionBridge を構築しハンドルを登録する組立処理を仕上げる。
  - feature 無効や設定で Disabled 判定となる場合は Runtime 生成をスキップし ActorSystem を変更しないルートを実装する。
  - 設定検証やトポロジ検知の失敗時に説明的エラーを返し、成功時のみ Ready を保存する起動ガードを追加する。
  - Installer API から Runtime/Context/Bridge/Metrics へ一貫アクセスできる公開インターフェイスを整える。
  - _対応要件: 1.1, 1.2, 1.3, 1.4_
  - _依存タスク: 1.1_
  - _完了条件: install 経路の単体テストで Ready/Disabled/Error 分岐が網羅されること_

- [ ] 2. トポロジ監視とブロックリスト連携
  - _対応要件: 2.1, 2.2, 2.3, 2.4_
  - _依存タスク: 1.2_
  - _完了条件: 2.x 子タスク完了かつ TopologyStream 更新・停止・ブロック通知が想定通り処理されること_

- [x] 2.1 TopologyStream 購読と停止時リカバリ
  - トポロジ購読開始と最新スナップショットの保持を行い、ハンドル経由で終了シグナルを監視する。
  - 終了や停止を検知したら警告ログを出し、最後のスナップショットを保持したまま再購読/バックオフを試行する。
  - 再購読確立後に最新スナップショットをランタイムへ再適用し、監視を継続する。
  - _対応要件: 2.1, 2.4_
  - _依存タスク: 1.2_
  - _完了条件: 購読再開シナリオのテストが通り、停止時に警告ログと待機動作が確認できること_

- [x] 2.2 トポロジ変更ハンドリングとハッシュ不変ガード
  - 新スナップショット受信時にハッシュ差分を検出し、変化がなければ既存 ownership とキャッシュを再利用する。
  - 変化がある場合は ownership を再計算し、影響する PID/リースを無効化して整合させる。
  - 更新後の所有権セットをメトリクス・イベントと連携し、再計算結果を観測できるようにする。
  - _対応要件: 2.1, 2.2_
  - _依存タスク: 2.1_
  - _完了条件: ハッシュ不変/変化の両ケースを含む単体テストが緑で、再利用と再計算が分岐確認できること_

- [x] 2.3 ブロックリスト適用とリース失効
  - ブロック通知を受けて当該ノード所有リースをすべて失効させ、関連キャッシュを無効化する処理を追加する。
  - BlockListApplied イベントを発行し、イベントストリーム経由で購読者へ届くようにする。
  - メトリクスにブロック適用を記録し、後続の解決・活性化に影響が及ぶことを確認する。
  - _対応要件: 2.3_
  - _依存タスク: 2.2_
  - _完了条件: ブロック適用時のリース失効とイベント発火を検証するテストが緑になること_

- [ ] 3. Placement 経路と Graceful Shutdown 整合
  - _対応要件: 3.1, 3.2, 3.3, 3.4, 3.5_
  - _依存タスク: 2.3_
  - _完了条件: 3.x 子タスク完了かつ Activation/Shutdown フローが一貫して動作すること_

- [x] 3.1 Activation 要求パスの組立て
  - 所有ノード解決時にリース情報と起動パラメータを含む要求を Placement 側へ渡す経路を整備する。
  - PartitionBridge を通じて要求を投入し、成功時にランタイム内部キャッシュへ反映する。
  - 再入隊列や多重投入を避けるガードを設け、既存リースの再利用を優先する。
  - _対応要件: 3.1_
  - _依存タスク: 2.3_
  - _完了条件: 正常系で Activation 要求が Placement まで到達しリースが有効化されることをテストで確認_

- [x] 3.2 Activation 失敗・Terminated 処理
  - 失敗応答を受けたリースを解放し、失敗イベントを発行する処理を追加する。
  - Terminated 通知を受けた追跡リースを削除し、関連 PID キャッシュを無効化する。
  - ロスや重複を防ぐため、リース状態とイベント発行を一貫したトランジションで管理する。
  - _対応要件: 3.2, 3.3_
  - _依存タスク: 3.1_
  - _完了条件: 失敗/終了シナリオのテストが緑で、リース解放とイベント発火が確認できること_

- [x] 3.3 Graceful Shutdown と拒否制御
  - Shutdown 開始で新規解決/活性化要求を拒否し、既存リース解放が終わるまで待機する経路を実装する。
  - 全リース解放後に仮想アクター数メトリクスをゼロ更新し、完了をブートストラップ API に通知する。
  - Shutdown 中のイベント・エラー整備（ShuttingDown 応答）でクライアントに一貫した結果を返す。
  - _対応要件: 3.4, 3.5_
  - _依存タスク: 3.2_
  - _完了条件: Shutdown フローの統合テストが緑で、拒否・解放・完了通知が確認できること_

- [ ] 4. Routing・リトライ・観測メトリクス
  - _対応要件: 4.1, 4.2, 4.3, 4.4, 4.5_
  - _依存タスク: 3.3_
  - _完了条件: 4.x 子タスク完了かつ Routing/メトリクス/イベント観測が動作すること_

- [x] 4.1 ClusterContext リクエスト経路とリトライ制御
  - リクエスト処理で PID キャッシュを優先し、未ヒット時のみ解決経路へフォールバックする。
  - RetryPolicy の試行回数を超えた場合に Timeout を返し、同時にリトライ回数をメトリクスへ記録する。
  - 成功時・失敗時の遅延計測を行い、後続の観測タスクで利用できるようにする。
  - _対応要件: 4.1, 4.2_
  - _依存タスク: 3.3_
  - _完了条件: リトライ上限・Timeout 応答を含む経路の単体テストが緑になること_

- [x] 4.2 ClusterMetrics 拡張とゲージ更新
  - resolve/request のレイテンシ、リトライ/Timeout カウンタ、actor-count ゲージ、ブロックリストカウンタを計測・更新する。
  - グレースフルシャットダウン完了時に actor-count をゼロへ反映し、関連メトリクスをフラッシュする。
  - 収集値を後続のテレメトリ/輸出フックへ渡せるようインターフェイスを整備する。
  - _対応要件: 4.2, 4.3, 4.5_
  - _依存タスク: 4.1_
  - _完了条件: メトリクス更新の単体テストが緑で、Timeout/リトライ/ゲージ反映が確認できること_

- [x] 4.3 ClusterEventStreamAdapter のイベント配送
  - ActivationStarted や BlockListApplied などクラスタイベントを EventStream へ配送するアダプタを実装する。
  - enqueued イベントをロストなく flush し、購読者が受信できることを確認する。
  - 運用監視に必要なイベント種を漏れなくカバーし、重複送出がないことを検証する。
  - _対応要件: 4.4_
  - _依存タスク: 4.2_
  - _完了条件: イベント配送の単体テストが緑で、指定イベントが購読者に届くこと_

- [x] 5. テストと検証
  - _対応要件: 1系, 2系, 3系, 4系 のすべて_
  - _依存タスク: 4.3_
  - _完了条件: 5.x 子タスク完了かつ全テストが green、主要シナリオを網羅すること_

- [x] 5.1 単体テストカバレッジ強化
  - BootstrapStatusStore、ブートストラップ分岐、トポロジ再購読、ブロック適用、メトリクス更新、イベントアダプタなど基盤コンポーネントを個別に検証する。
  - リトライ上限・Timeout・ゲージゼロ化の境界ケースを含め、異常系を網羅する。
  - _対応要件: 1.1, 1.2, 1.5, 2.1, 2.2, 2.3, 2.4, 4.2, 4.3, 4.4, 4.5_
  - _依存タスク: 4.3_
  - _完了条件: 対象コンポーネントの単体テストが追加され CI で green になること_

- [x] 5.2 統合テストとフェイルシナリオ検証
  - ブートストラップから Topology 更新→解決→Activation→ブロック通知→Shutdown までの一連フローを std 環境で実行する統合テストを追加する。
  - 無効設定・TopologyStream 停止・PartitionBridge 生成失敗などのフェイルシナリオで正しいエラー応答とスキップ動作を確認する。
  - メトリクスとイベントが統合テスト中に記録・配信されることを検証する。
  - _対応要件: 1.1, 1.2, 1.3, 2.1, 2.3, 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.4_
  - _依存タスク: 5.1_
  - _完了条件: 統合テストが CI で green となり、主要フェイルケースが再現できること_
